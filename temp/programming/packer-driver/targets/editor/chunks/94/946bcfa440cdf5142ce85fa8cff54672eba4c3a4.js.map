{"version":3,"sources":["file:///C:/CocosWorkspace/Cocos_2048/assets/scripts/Game.ts"],"names":["_decorator","Component","instantiate","Label","Node","NodeEventType","Prefab","randomRangeInt","tween","UITransform","Vec3","view","Block","ccclass","property","gBlockHorizontalNum","gBlockVerticalNum","gRandomGenerateNumbers","gTouchMoveThreshold","Game","type","score","gap","blockSize","blockPositions","blocks","startPosition","endPosition","moveDirection","canOperate","acuallyMoved","prevMerged","drawBgBlocks","getVisibleSize","width","y","i","x","push","Array","j","block","blockPrefab","blockUiTransform","getComponent","height","setPosition","setNumber","background","addChild","init","updateScore","length","destroy","addRandomNumberBlock","num","scoreLabel","string","getFreeBlocksXy","freeBlocksXy","index","pos","moveAninmation","callback","t","to","worldPosition","easing","call","start","inRange","checkFail","move","tx","ty","getNumber","removeChild","doMove","startx","endx","starty","endy","stepx","stepy","toMove","cur","moveFinish","moveRight","console","log","moveLeft","moveUp","moveDown","touchEnd","event","getLocation","dirVec","subtract","Math","abs","addEventHandler","on","TOUCH_START","TOUCH_END","TOUCH_CANCEL","update","deltaTime"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Label, Node, NodeEventType, Prefab, randomRangeInt, Sprite, tween, UITransform, Vec2, Vec3, view } from 'cc';\nimport { colors }  from './Colors';\nimport { Block } from './Block';\nconst { ccclass, property } = _decorator;\n\n// 格子行数\nconst gBlockHorizontalNum: number = 4;\n// 格子列数\nconst gBlockVerticalNum: number = 4;\n// 新格子可能随机生成的数字\nconst gRandomGenerateNumbers: number[] = [2, 4];\n// 操作滑动距离阈值，超过该阈值才认为是有效的滑动，否则不响应，单位是像素\nconst gTouchMoveThreshold: number = 50;\n\n@ccclass('Game')\nexport class Game extends Component {\n    @property({type: Label})\n    private scoreLabel: Label;\n    private score: number = 0;\n    @property({type: Prefab})\n    private blockPrefab: Prefab;\n    private gap: number = 20;\n    @property({type: Node})\n    private background: Node;\n    private blockSize: number = 0;\n    private blockPositions: Vec3[][] = [];\n    private blocks: Node[][] = [];\n    private startPosition: Vec2;\n    private endPosition: Vec2;\n    private moveDirection = [0, -1]; //默认向左移动\n    private canOperate = true;\n    private acuallyMoved = false;   // 如果滑动事件后，没有一个格子能移动，则不新增格子\n    // 前一次滑动是否是相同分数的合并，避免连环合并的情况\n    // 如: 2 2 4，向左划，应该是4 4，而不应该是8\n    private prevMerged: boolean[][] = [];\n\n    drawBgBlocks() {\n        this.blockSize = \n            (view.getVisibleSize().width - this.gap * (gBlockHorizontalNum + 1)) / gBlockHorizontalNum;\n\n        this.blockPositions = [];\n        var y = this.gap + this.blockSize / 2;\n        for (var i=0;i<gBlockVerticalNum;++i) {\n            var x = this.gap + this.blockSize / 2;\n            this.blockPositions.push(new Array<Vec3>(gBlockHorizontalNum));\n            for(var j=0;j<gBlockHorizontalNum;++j) {\n                var block = instantiate(this.blockPrefab);\n                var blockUiTransform = block.getComponent(UITransform);\n                blockUiTransform.width = blockUiTransform.height = this.blockSize;\n                block.setPosition(x, y, 0);\n                this.blockPositions[i][j] = new Vec3(x, y, 1);\n                block.getComponent(Block).setNumber(0);\n                this.background.addChild(block);\n                x += this.gap + this.blockSize;\n            }\n            y += this.gap + this.blockSize;\n        }\n        // console.log(this.blockPositions);\n    }\n\n    // 初始化的时候调用一次\n    init() {\n        this.updateScore(0);\n\n        for(var i=0;i<this.blocks.length;++i) {\n            for(var j=0;j<this.blocks[i].length;++j) {\n                if (this.blocks[i][j] != null) {\n                    this.blocks[i][j].destroy();\n                }\n            }\n        }\n\n        this.blocks = [];\n        for (var i=0;i<gBlockVerticalNum;++i) {\n            this.blocks.push(new Array<Node>(gBlockHorizontalNum));\n            for (var j=0;j<gBlockHorizontalNum;++j) {\n                this.blocks[i][j] = null;\n            }\n        }\n        // console.log(this.blocks);\n        // console.log(this.getFreeBlocksXy());\n\n        this.addRandomNumberBlock();\n        this.addRandomNumberBlock();\n        this.addRandomNumberBlock();\n    }\n\n    // 更新总分数\n    updateScore(num: number) {\n        this.score = num;\n        this.scoreLabel.string = '分数: ' + num;\n    }\n\n    // 获取空白块的xy下标\n    getFreeBlocksXy() {\n        var freeBlocksXy = [];\n        for(var i = 0; i<this.blocks.length;++i) {\n            for(var j =0;j<this.blocks[i].length;++j) {\n                if (this.blocks[i][j] == null) {\n                    freeBlocksXy.push([i, j]);\n                }\n            }\n        }\n        return freeBlocksXy;\n    }\n\n    // 随机在空白位置处添加一个数字块\n    addRandomNumberBlock() {\n        var freeBlocksXy = this.getFreeBlocksXy();\n        if (freeBlocksXy.length == 0) return false;\n        var index = freeBlocksXy[randomRangeInt(0, freeBlocksXy.length)];\n        // console.log(index);\n        var pos = this.blockPositions[index[0]][index[1]];\n        // console.log(pos);\n        var block = instantiate(this.blockPrefab);\n        var blockUiTransform = block.getComponent(UITransform);\n        blockUiTransform.width = blockUiTransform.height = this.blockSize;\n        block.setPosition(pos);\n        // console.log(gRandomGenerateNumbers[randomRangeInt(0, gRandomGenerateNumbers.length)]);\n        block.getComponent(Block).setNumber(gRandomGenerateNumbers[randomRangeInt(0, gRandomGenerateNumbers.length)]);\n        this.background.addChild(block);\n        // console.log(this.background.children)\n        this.blocks[index[0]][index[1]] = block;\n        return true;\n    }\n\n    moveAninmation(block: Node, pos: Vec3, callback) {\n        this.acuallyMoved = true;\n        var t = tween(block);\n        t.to(0.01, {worldPosition: pos}, {easing: 'backOut'});\n        t.call(()=>{\n            callback && callback();\n        })\n        t.start();\n    }\n\n    inRange(x, y) {\n        return x >= 0 && x < gBlockHorizontalNum && y >=0 && y < gBlockVerticalNum;\n    }\n\n    checkFail() {\n        return false;\n    }\n\n    move(x, y, callback) {\n        var tx = x + this.moveDirection[0];\n        var ty = y + this.moveDirection[1];\n\n        if (!this.inRange(tx, ty)) {\n            callback && callback();\n        } else if (this.blocks[tx][ty] == null) {\n            var pos = this.blockPositions[tx][ty];\n            this.blocks[tx][ty] = this.blocks[x][y]\n            this.blocks[x][y] = null;\n            this.moveAninmation(this.blocks[tx][ty], pos, () => {\n                this.move(tx, ty, callback);\n            });\n        } else if (this.blocks[tx][ty].getComponent(Block).getNumber() ==\n            this.blocks[x][y].getComponent(Block).getNumber()) {\n            if (this.prevMerged[tx][ty]) {\n                callback && callback();\n                return;\n            }\n            var pos = this.blockPositions[tx][ty];\n            this.moveAninmation(this.blocks[x][y], pos, () => {\n                var num = this.blocks[tx][ty].getComponent(Block).getNumber();\n                this.blocks[tx][ty].getComponent(Block).setNumber(num * 2);\n                this.background.removeChild(this.blocks[x][y]);\n                this.blocks[x][y].destroy();\n                this.blocks[x][y] = null;\n                this.prevMerged[tx][ty] = true;\n                callback && callback();\n            });\n        } else { //和前一个格子数字不一样\n            callback && callback();\n        }\n    }\n\n    doMove(startx, endx, starty, endy, stepx, stepy) {\n        var toMove = [];\n        for (var i:number=startx;i!=endx;i+=stepx) {\n            for(var j=starty;j!=endy;j+=stepy) {\n                if (this.blocks[i][j] != null) {\n                    toMove.push([i,j]);\n                }\n            }\n        }\n        var cur = 0;\n        var moveFinish = () => {\n            cur++;\n            if (cur == toMove.length) {\n                if (this.acuallyMoved) {\n                    this.updateScore(this.score + 1);\n                    this.addRandomNumberBlock();\n                }\n                if (this.checkFail()) {\n                    \n                }\n                this.canOperate = true;\n            } else {\n                this.move(toMove[cur][0], toMove[cur][1], moveFinish);\n            }\n        };\n        this.move(toMove[cur][0], toMove[cur][1], moveFinish);\n    }\n\n    moveRight() {\n        console.log('move right');\n        this.moveDirection = [0, 1];\n        var startx=0, endx=gBlockHorizontalNum;\n        var starty=gBlockVerticalNum-1, endy=-1;\n        this.doMove(startx, endx, starty, endy, 1, -1);\n    }\n\n    moveLeft() {\n        console.log('move left');\n        this.moveDirection = [0, -1];\n        var startx=0, endx=gBlockHorizontalNum;\n        var starty=0, endy=gBlockVerticalNum;\n        this.doMove(startx, endx, starty, endy, 1, 1);\n    }\n\n    moveUp() {\n        console.log('move up');\n        this.moveDirection = [1, 0];\n        var startx=gBlockHorizontalNum-1, endx=-1;\n        var starty=0, endy=gBlockVerticalNum;\n        this.doMove(startx, endx, starty, endy, -1, 1);\n    }\n\n    moveDown() {\n        console.log('move down');\n        this.moveDirection = [-1, 0];\n        var startx=0, endx=gBlockHorizontalNum;\n        var starty=0, endy=gBlockVerticalNum;\n        this.doMove(startx, endx, starty, endy, 1, 1);\n    }\n\n    touchEnd(event) {\n        if (this.canOperate == false) {\n            return;\n        }\n        this.endPosition = event.getLocation();\n        // console.log(this.endPosition);\n        var dirVec = this.endPosition.subtract(this.startPosition);\n        // console.log(dirVec);\n        if (dirVec.length() > gTouchMoveThreshold) {\n            this.canOperate = false;\n            this.acuallyMoved = false;\n            for(var i=0;i<gBlockHorizontalNum;++i) {\n                this.prevMerged[i]=[];\n                for(var j=0;j<gBlockVerticalNum;++j) {\n                    this.prevMerged[i][j] = false;\n                }\n            }\n            if (Math.abs(dirVec.x) > Math.abs(dirVec.y)) { // 水平滑动\n                if (dirVec.x > 0) {\n                    this.moveRight();\n                } else {\n                    this.moveLeft();\n                }\n            } else { // 竖直滑动\n                if (dirVec.y > 0) {\n                    this.moveUp();\n                } else {\n                    this.moveDown();\n                }\n            }\n        }\n    }\n\n    addEventHandler() {\n        this.background.on(NodeEventType.TOUCH_START, (event) => {\n            this.startPosition = event.getLocation();\n            // console.log(this.startPosition);\n        });\n\n        this.background.on(NodeEventType.TOUCH_END, (event) => {\n            this.touchEnd(event);\n        });\n\n        this.background.on(NodeEventType.TOUCH_CANCEL, (event) => {\n            this.touchEnd(event);\n        });\n    }\n\n    start() {\n        this.drawBgBlocks();\n        this.init();\n        this.addEventHandler();\n    }\n\n    update(deltaTime: number) {\n        \n    }\n}\n\n"]}